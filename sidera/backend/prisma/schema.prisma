generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Project {
  id        String   @id @default(uuid())
  ownerId   String   // Guest ID
  title     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  turns     Turn[]
  edges     Edge[]
  snapshots Snapshot[]
}

model Turn {
  id           String     @id @default(uuid())
  projectId    String
  project      Project    @relation(fields: [projectId], references: [id])
  parentTurnId String?
  parentTurn   Turn?      @relation("TurnHistory", fields: [parentTurnId], references: [id])
  childTurns   Turn[]     @relation("TurnHistory")
  
  roleUserText String
  roleAiText   String     @db.Text
  status       TurnStatus @default(STREAMING)
  
  // Coordinates (Deterministic)
  x            Float
  y            Float
  z            Float
  
  // Metadata
  importance   Int        @default(0) // 0-100
  starType     StarType   @default(BETA)
  pinned       Boolean    @default(false)
  tags         String[]
  summary      String?
  
  // Replace Policy
  isReplaced      Boolean   @default(false)
  replacedAt      DateTime?
  replacedReason  String?
  replacedByTurnId String?  // Optional link to new version

  createdAt    DateTime   @default(now())
  
  // Edges
  edgesFrom    Edge[]     @relation("EdgeFrom")
  edgesTo      Edge[]     @relation("EdgeTo")
}

model Edge {
  id         String   @id @default(uuid())
  projectId  String
  project    Project  @relation(fields: [projectId], references: [id])
  
  fromTurnId String
  fromTurn   Turn     @relation("EdgeFrom", fields: [fromTurnId], references: [id])
  toTurnId   String
  toTurn     Turn     @relation("EdgeTo", fields: [toTurnId], references: [id])
  
  type       EdgeType @default(SOLID)
  createdAt  DateTime @default(now())
}

model Snapshot {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])
  
  title     String
  graphJson Json     // Full scene state: nodes, edges, camera, styling
  
  createdAt DateTime @default(now())
}

enum TurnStatus {
  STREAMING
  DONE
  ERROR
}

enum StarType {
  ALPHA      // Pinned
  BETA       // Default
  SATELLITE  // Short/Ack
  POTENTIAL  // Background
}

enum EdgeType {
  SOLID
  WARP
}
